pipeline {
  agent any
  
  tools { nodejs 'node20' }
  
  triggers {
    pollSCM('H/2 * * * *')
  }
  
  environment {
    GITHUB_CREDENTIALS = 'github-pat'
    GITHUB_USER = 'busra-ertekin'
    BUILD_REPO = "jenkins-builds"
    REPO_NAME = "jenkins-demo-project"
  }
  
  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: "https://github.com/${env.GITHUB_USER}/${env.REPO_NAME}.git",
            credentialsId: env.GITHUB_CREDENTIALS
          ]]
        ])
      }
    }
    
    stage('Install dependencies') {
      steps {
        sh '''
          echo "Current directory: $(pwd)"
          node -v
          npm ci
        '''
      }
    }
    
    stage('Bump version & tag') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: env.GITHUB_CREDENTIALS,
          usernameVariable: 'GIT_USER',
          passwordVariable: 'GIT_TOKEN'
        )]) {
          sh '''
            echo "Git status before bump:"
            git status
            
            git config user.email "jenkins@busra-ertekin.com"
            git config user.name "jenkins-ci"
            
            git remote set-url origin https://${GIT_TOKEN}@github.com/${GITHUB_USER}/${REPO_NAME}.git
            
            npm version patch -m "ci: bump version to %s [ci skip]"
            
            git push origin HEAD:main --follow-tags
            
            echo "âœ… Version bumped and pushed to GitHub"
          '''
        }
      }
    }
    
    stage('Build Application') {
      steps {
        sh '''
          echo "Building Next.js application..."
          npm run build
          echo "âœ… Build completed"
        '''
      }
    }
    
    stage('Docker build') {
      steps {
        sh '''
          IMAGE_TAG="${GITHUB_USER}/${REPO_NAME}:$(git rev-parse --short HEAD)"
          echo "Building Docker image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          echo "âœ… Docker image built: $IMAGE_TAG"
        '''
      }
    }
    
    stage('Create and Push Artifact') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: env.GITHUB_CREDENTIALS,
          usernameVariable: 'GIT_USER',
          passwordVariable: 'GIT_TOKEN'
        )]) {
          sh '''
            set -e  # Hata durumunda dur
            
            # Tarih ve commit bilgilerini al
            BUILD_DATE=$(date +"%Y%m%d-%H%M%S")
            COMMIT_SHA=$(git rev-parse --short HEAD)
            VERSION=$(node -p "require('./package.json').version")
            
            # Artifact adÄ±: artifact-v0.1.3-20251027-143022-a1b2c3d.tar.gz
            ARTIFACT_NAME="artifact-v${VERSION}-${BUILD_DATE}-${COMMIT_SHA}.tar.gz"
            
            echo "================================================"
            echo "Creating artifact: ${ARTIFACT_NAME}"
            echo "Version: v${VERSION}"
            echo "Date: ${BUILD_DATE}"
            echo "Commit: ${COMMIT_SHA}"
            echo "================================================"
            
            # Tar dosyasÄ± oluÅŸtur
            tar -czf ${ARTIFACT_NAME} .next package.json package-lock.json
            
            echo "âœ… Artifact created: $(ls -lh ${ARTIFACT_NAME})"
            
            # GeÃ§ici dizin oluÅŸtur
            TMPDIR=$(mktemp -d)
            echo "Temp directory: $TMPDIR"
            
            # jenkins-builds reposunu klonla
            echo "Cloning jenkins-builds repository..."
            git clone https://${GIT_TOKEN}@github.com/${GITHUB_USER}/${BUILD_REPO}.git $TMPDIR
            
            # Artifact'Ä± kopyala
            cp ${ARTIFACT_NAME} $TMPDIR/
            
            # jenkins-builds'e push
            cd $TMPDIR
            
            git config user.email "jenkins@busra-ertekin.com"
            git config user.name "jenkins-ci"
            
            git add ${ARTIFACT_NAME}
            
            # DetaylÄ± commit mesajÄ±
            COMMIT_MSG="ğŸš€ Add build artifact ${ARTIFACT_NAME}

Project: ${REPO_NAME}
Version: v${VERSION}
Build Date: ${BUILD_DATE}
Commit: ${COMMIT_SHA}
Build Number: ${BUILD_NUMBER}

Generated by Jenkins CI/CD Pipeline"
            
            git commit -m "${COMMIT_MSG}"
            
            echo "Pushing to GitHub..."
            git push origin HEAD:main
            
            # Temizlik
            cd -
            rm -rf $TMPDIR
            
            echo "================================================"
            echo "âœ… SUCCESS! Artifact pushed to GitHub"
            echo "Repository: https://github.com/${GITHUB_USER}/${BUILD_REPO}"
            echo "File: ${ARTIFACT_NAME}"
            echo "================================================"
          '''
        }
      }
    }
    
    stage('Create Build Summary') {
      steps {
        sh '''
          BUILD_DATE=$(date +"%Y-%m-%d %H:%M:%S")
          COMMIT_SHA=$(git rev-parse --short HEAD)
          VERSION=$(node -p "require('./package.json').version")
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           BUILD SUMMARY                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Project:        ${REPO_NAME}"
          echo "ğŸ·ï¸  Version:        v${VERSION}"
          echo "ğŸ“… Build Date:     ${BUILD_DATE}"
          echo "ğŸ”– Commit:         ${COMMIT_SHA}"
          echo "ğŸ”¢ Build Number:   ${BUILD_NUMBER}"
          echo ""
          echo "ğŸ“ Repositories:"
          echo "   Source:  https://github.com/${GITHUB_USER}/${REPO_NAME}"
          echo "   Builds:  https://github.com/${GITHUB_USER}/${BUILD_REPO}"
          echo ""
          echo "âœ… All stages completed successfully!"
          echo ""
        '''
      }
    }
  }
  
  post {
    success {
      echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
      echo 'â•‘     âœ… PIPELINE COMPLETED SUCCESSFULLY!       â•‘'
      echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    }
    failure {
      echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
      echo 'â•‘          âŒ PIPELINE FAILED!                  â•‘'
      echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    }
    always {
      cleanWs()
    }
  }
}
```

## ğŸ“‹ Artifact Ä°simlendirme FormatÄ±

ArtÄ±k artifact'lar ÅŸu formatta olacak:
```
artifact-v0.1.3-20251027-143022-a1b2c3d.tar.gz
         â”‚      â”‚                â”‚
         â”‚      â”‚                â””â”€ Commit SHA (kÄ±sa)
         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tarih ve Saat (YYYYMMdd-HHmmss)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Version (package.json'dan)
```

**Ã–rnek artifact adlarÄ±:**
- `artifact-v0.1.3-20251027-143022-6429953.tar.gz`
- `artifact-v0.1.4-20251027-150530-a1b2c3d.tar.gz`
- `artifact-v0.1.5-20251027-163045-f3e4d5c.tar.gz`

## ğŸ¯ Ne YapÄ±yor?

1. âœ… **Version Bump**: `package.json`'da version artÄ±rÄ±lÄ±r (0.1.2 â†’ 0.1.3)
2. âœ… **Git Tag**: Yeni version iÃ§in tag oluÅŸturulur (v0.1.3)
3. âœ… **Push to Source**: `jenkins-demo-project` reposuna push edilir
4. âœ… **Build**: Next.js uygulamasÄ± build edilir
5. âœ… **Docker Image**: Docker image oluÅŸturulur
6. âœ… **Create Artifact**: Tarihli artifact oluÅŸturulur
7. âœ… **Push to Builds**: `jenkins-builds` reposuna artifact push edilir

## ğŸ“‚ jenkins-builds Reposunda GÃ¶rÃ¼nÃ¼m
```
jenkins-builds/
â”œâ”€â”€ artifact-v0.1.3-20251027-143022-6429953.tar.gz
â”œâ”€â”€ artifact-v0.1.4-20251027-150530-a1b2c3d.tar.gz
â”œâ”€â”€ artifact-v0.1.5-20251027-163045-f3e4d5c.tar.gz
â””â”€â”€ README.md
```

Her artifact'Ä±n commit mesajÄ± detaylÄ± olacak:
```
ğŸš€ Add build artifact artifact-v0.1.3-20251027-143022-6429953.tar.gz

Project: jenkins-demo-project
Version: v0.1.3
Build Date: 20251027-143022
Commit: 6429953
Build Number: 15

Generated by Jenkins CI/CD Pipeline